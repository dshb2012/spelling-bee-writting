<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spelling Bee</title>

<link rel="manifest" href="manifest.json">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding-top: 60px;
}

#timerBox {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #d32f2f;
  color: white;
  text-align: center;
  font-size: 18px;
  padding: 10px;
  z-index: 9999;
}

.controls {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin: 10px;
}

button {
  padding: 8px 12px;
  font-size: 14px;
}

table {
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #ccc;
  padding: 6px;
}

tr.active {
  background: #c8e6ff;
}
</style>
</head>

<body>

<div id="timerBox">Timer: -</div>

<div class="controls">
  <input type="file" id="fileInput" accept=".csv">
  <button onclick="playAll()">‚ñ∂ Play All</button>
  <button onclick="pausePlay()">‚è∏ Pause</button>
  <button onclick="resumePlay()">‚ñ∂ Resume</button>
  <button onclick="stopPlay()">‚èπ Stop</button>
  <input type="number" id="startRow" placeholder="Baris ke..." style="width:90px">
  <button onclick="playFromRow()">üî¢ Play dari Baris</button>
</div>

<table id="dataTable"></table>

<script>
let data = [];
let currentRow = 0;
let paused = false;
let stopped = false;
let voice = new SpeechSynthesisUtterance();
voice.lang = "en-US";

document.getElementById("fileInput").addEventListener("change", loadCSV);

function loadCSV(e) {
  const reader = new FileReader();
  reader.onload = () => {
    const lines = reader.result.split("\n");
    data = lines.map(l => l.split(","));
    renderTable();
  };
  reader.readAsText(e.target.files[0]);
}

function renderTable() {
  const table = document.getElementById("dataTable");
  table.innerHTML = "";
  data.forEach((row, i) => {
    const tr = document.createElement("tr");
    row.slice(0,3).forEach(cell => {
      const td = document.createElement("td");
      td.textContent = cell;
      tr.appendChild(td);
    });

    const tdSpell = document.createElement("td");
    const btnSpell = document.createElement("button");
    btnSpell.textContent = "üî§ Spelling";
    btnSpell.onclick = () => spelling(i);
    tdSpell.appendChild(btnSpell);
    tr.appendChild(tdSpell);

    table.appendChild(tr);
  });
}

async function playAll() {
  stopped = false;
  paused = false;
  for (let i = currentRow; i < data.length; i++) {
    if (stopped) break;
    currentRow = i;
    await playRow(i);
  }
}

function playFromRow() {
  const r = parseInt(document.getElementById("startRow").value) - 1;
  if (!isNaN(r)) {
    currentRow = r;
    playAll();
  }
}

function pausePlay() {
  paused = true;
  speechSynthesis.pause();
}

function resumePlay() {
  paused = false;
  speechSynthesis.resume();
}

function stopPlay() {
  stopped = true;
  speechSynthesis.cancel();
  document.getElementById("timerBox").textContent = "Timer: -";
}

async function playRow(i) {
  highlightRow(i);
  await speak(data[i][0]);
  await wait(400);
  await speak(data[i][1]);
  await wait(400);
  await speak(data[i][2]);
  await countdown(20);
}

function spelling(i) {
  const word = data[i][2];
  speak(word);
  wait(300).then(async () => {
    for (let c of word) {
      await speak(c);
      await wait(300);
    }
    speak(word);
  });
}

function speak(text) {
  return new Promise(res => {
    voice.text = text;
    voice.onend = res;
    speechSynthesis.speak(voice);
  });
}

function wait(ms) {
  return new Promise(res => setTimeout(res, ms));
}

async function countdown(sec) {
  for (let i = sec; i > 0; i--) {
    document.getElementById("timerBox").textContent = "Next row in " + i + "s";
    await wait(1000);
    if (stopped) break;
  }
}

function highlightRow(i) {
  document.querySelectorAll("tr").forEach(tr => tr.classList.remove("active"));
  document.querySelectorAll("tr")[i]?.classList.add("active");
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
